<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile - EcoSwap</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Poppins:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background: url("{{ url_for('static', filename='uploads/websitebackground.png') }}") no-repeat center center fixed;
      background-size: cover;
      color: #333;
      margin: 0;
      padding: 0;
      /* Changed height to min-height to allow scrolling with many products */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 90%;
      max-width: 1000px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 30px;
      margin: 40px 0;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 2.2rem;
      color: #2e7d32; /* Eco Green */
      margin-bottom: 20px;
    }

    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 20px;
    }

    .back-button {
      background-color: #66bb6a;
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      transition: 0.3s;
    }

    .back-button:hover { background-color: #388e3c; }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 20px;
      text-align: left;
    }

    .profile-info img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid #66bb6a;
      object-fit: cover;
    }

    .profile-details h2 { margin: 0; color: #333; }
    .profile-details p { margin: 2px 0; color: #666; font-size: 0.9rem; }

    .listing-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
    }

    .card:hover { transform: translateY(-5px); }

    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .card-content { padding: 15px; flex-grow: 1; }
    .card-title { font-weight: bold; font-size: 1.1rem; color: #2e7d32; }

    /* Improved Sold Info */
    .sold-info {
      background-color: #e8f5e9;
      color: #2e7d32;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: bold;
      border-left: 5px solid #2e7d32;
    }

    .sold-info small { display: block; color: #555; font-size: 0.8rem; }

    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 15px;
      background: #f9f9f9;
    }

    .delete-btn { background: #ef5350; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
    .view-orders-btn { background: #42a5f5; color: white; text-decoration: none; padding: 8px; border-radius: 5px; font-weight: bold; font-size: 0.9rem; }
    .toggle-sold-btn { background: #ffa726; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; }

    .empty-state { padding: 40px; color: #888; font-style: italic; }

    /* Notification Badge Styling */
    .btn-wrapper {
        position: relative;
        display: block;
        width: 100%;
    }

    .notification-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: #ff5252;
        color: white;
        border-radius: 50%;
        padding: 2px 7px;
        font-size: 0.75rem;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 5;
    }

    /* Ensure buttons inside wrappers look consistent */
    .btn-wrapper .view-orders-btn {
        display: block;
        text-align: center;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="profile-header">
      <div class="profile-info">
        <img src="{{ url_for('static', filename='uploads/default-avatar.jpg') }}" alt="User">
        <div class="profile-details">
          <h2>{{ current_user.full_name }}</h2>
          <p>@{{ current_user.username }}</p>
          <p>{{ current_user.email }}</p>
        </div>
      </div>
      <a href="{{ url_for('home') }}" class="back-button">← Home</a>
    </div>

    <h1>My Listed Items</h1>

    {% if products %}
      <div class="listing-container">
        {% for product in products %}
          <div class="card">
            <img src="{{ url_for('static', filename='uploads/' + product.image_filename) if product.image_filename else url_for('static', filename='uploads/default.jpg') }}">
            
            <div class="card-content">
              <div class="card-title">{{ product.title }}</div>
              <p class="card-desc">{{ product.description[:60] }}...</p>

              {% if product.sold %}
                <div class="sold-info">
                  ✓ Swapped Successfully
                  {% if product.buyer %}
                    <small>Buyer: {{ product.buyer.username }}</small>
                  {% endif %}
                </div>
              {% endif %}
            </div>

            <div class="btn-group">
              {% if not product.sold %}
                <div class="btn-wrapper">
                  <a href="{{ url_for('orders_for_product', product_id=product.id) }}" class="view-orders-btn">
                    View Swap Requests
                  </a>
                  
                  {% if product.requests|length > 0 %}
                    <span class="notification-badge">{{ product.requests|length }}</span>
                  {% endif %}
                </div>
                <form action="{{ url_for('delete_product', product_id=product.id) }}" method="POST">
                  <button class="delete-btn" type="submit" onclick="return confirm('Delete this item?')">Delete Listing</button>
                </form>
              {% endif %}

              <form method="POST" action="{{ url_for('toggle_sold', product_id=product.id) }}">
                <button type="submit" class="toggle-sold-btn">
                  {{ 'Relist Item' if product.sold else 'Mark as Sold' }}
                </button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <p>You haven't listed any items for swap yet.</p>
        <a href="{{ url_for('add_product') }}" class="back-button">Add Your First Product</a>
      </div>
    {% endif %}
  </div>

</body>
</html>